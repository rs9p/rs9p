name: Publish release

permissions:
    actions: none
    checks: none
    contents: write
    deployments: none
    id-token: none
    issues: none
    discussions: none
    packages: none
    pages: none
    pull-requests: none
    repository-projects: none
    security-events: none
    statuses: none

on:
    push:
        tags:
            - v*

env:
    CARGO_TERM_COLOR: always

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2

            - name: Create release
              id: create_release
              uses: "softprops/action-gh-release@v2"
              with:
                  draft: false
                  prerelease: false
                  token: ${{ secrets.GITHUB_TOKEN }}

    build-linux:
        runs-on: ubuntu-latest
        needs: release
        steps:
            - uses: actions/checkout@v2

            - name: Run tests
              run: cargo test --all

            - name: Run build
              run: |
                  cargo build -p unpfs --release
                  strip --strip-all ./target/release/unpfs
                  mv ./target/release/unpfs unpfs

            - name: Upload release
              id: upload-release-linux
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      unpfs

              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
